---
# https://taskfile.dev
version: "3"

dotenv: [".env"]

includes:
  agent:
    taskfile: ./agent_retrieval_agent/Taskfile.yml
    dir: ./agent_retrieval_agent
  core:
    taskfile: ./core/Taskfile.yaml
    dir: ./core
  exec-env:
    taskfile: ./execution_environments/Taskfile.yaml
    dir: ./execution_environments
    optional: true
  frontend:
    taskfile: ./frontend_web/Taskfile.yaml
    dir: ./frontend_web
  web:
    taskfile: ./web/Taskfile.yaml
    dir: ./web
  infra:
    taskfile: ./infra/Taskfile.yaml
    dir: ./infra

tasks:
  install-all:
    desc: "ğŸ“¦ Install all dependencies for all subprojects that support it"
    deps:
      - agent:install
      - frontend:install
      - web:install
      - infra:install

  lint-all:
    desc: "ğŸ§¹ Lint all subprojects that support linting"
    deps:
      - core:lint
      - agent:lint
      - frontend:lint
      - infra:lint
      - web:lint

  test-all:
    desc: "ğŸ§ª Test all subprojects that support testing"
    deps:
      - web:test
      - frontend:test
      - agent:test
      - core:test

  dev-all:
    desc: "ğŸš€ Run agent, backend (web), and frontend together"
    cmds:
      - |
        task web:dev-agent &
        sleep 5
        task agent:dev &
        sleep 3
        task frontend:dev &
        sleep 8
        echo "âœ… All servers started!"
        if [[ -n "$NOTEBOOK_ID" ]]; then
          prefix="${DATAROBOT_API_ENDPOINT//api\/v2/}notebook-sessions/$NOTEBOOK_ID/ports/"
        else
          prefix="http://localhost:"
        fi
        echo "ğŸ”— Backend: ${prefix}8080"
        echo "ğŸ”— Frontend: ${prefix}5173"
        echo "ğŸ”— Agent: ${prefix}8842"
        wait

  deploy:
    desc: "ğŸš€ Deploy the infrastructure"
    cmds:
      - task infra:deploy

  verify:
    desc: "âœ… Quick verification (build + lint checks) - Fast alternative to deploy"
    cmds:
      - echo "ğŸ” Running quick verification checks..."
      - echo "1ï¸âƒ£ Checking frontend build..."
      - task frontend:build
      - echo "2ï¸âƒ£ Checking frontend lint..."
      - task frontend:lint-check
      - echo "3ï¸âƒ£ Checking agent lint..."
      - task agent:lint-check
      - echo "âœ… All checks passed! Ready for deployment."

  verify-fast:
    desc: "âš¡ Ultra-fast verification (frontend build only) - ~30 seconds"
    cmds:
      - echo "âš¡ Running fast verification (frontend build only)..."
      - task frontend:build
      - echo "âœ… Frontend build check passed!"
